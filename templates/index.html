{% extends "base.html" %}

{% block content %}
    {% include 'individual_testing.html' %}
    {% include 'profile_testing.html' %}
{% endblock %}

{% block scripts %}
<script>
    let isProcessing = false;

    // Function to display cleanup messages
    function displayCleanupMessages(messages, errors, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        // Add status messages
        messages.forEach(message => {
            container.innerHTML += `
                <div class="status-message info">
                    <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                    <span class="message-content"><i class="fas fa-info-circle"></i> ${message}</span>
                </div>
            `;
        });

        // Add error messages if any
        errors.forEach(error => {
            container.innerHTML += `
                <div class="status-message error">
                    <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                    <span class="message-content"><i class="fas fa-exclamation-circle"></i> ${error}</span>
                </div>
            `;
        });

        // Scroll to the bottom of the messages
        container.scrollTop = container.scrollHeight;
    }

    // Function to handle cleanup for both tabs
    function handleCleanup(hostSelectId, cleanupBtnId, statusSectionId, messagesContainerId) {
        const host = document.getElementById(hostSelectId).value;
        if (!host) {
            alert('Please select a target host before cleanup');
            return;
        }

        // Show the status section
        document.getElementById(statusSectionId).style.display = 'block';
        const messagesContainer = document.getElementById(messagesContainerId);
        messagesContainer.innerHTML = `
            <div class="status-message info">
                <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                <span class="message-content"><i class="fas fa-spinner fa-spin"></i> Starting cleanup...</span>
            </div>
        `;

        // Disable the cleanup button and show cleaning state
        const cleanupBtn = document.getElementById(cleanupBtnId);
        cleanupBtn.disabled = true;
        cleanupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cleaning...';

        fetch('/cleanup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ host: host })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'error') {
                console.error('Cleanup errors:', data.errors);
                displayCleanupMessages(data.messages, data.errors, messagesContainerId);
            } else {
                console.log('Cleanup success:', data.messages);
                displayCleanupMessages(data.messages, [], messagesContainerId);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            displayCleanupMessages([], [`Error during cleanup: ${error}`], messagesContainerId);
        })
        .finally(() => {
            // Re-enable the cleanup button and restore original text
            cleanupBtn.disabled = false;
            cleanupBtn.innerHTML = '<i class="fas fa-broom"></i> Cleanup';
        });
    }

    // Function to handle host selection for cleanup buttons
    function handleHostSelection(hostSelectId, cleanupBtnId) {
        const hostSelect = document.getElementById(hostSelectId);
        const cleanupBtn = document.getElementById(cleanupBtnId);
        
        hostSelect.addEventListener('change', function() {
            cleanupBtn.disabled = !this.value;
        });
    }

    // Initialize host selection handlers for both tabs
    handleHostSelection('host', 'cleanup-btn');
    handleHostSelection('profile-host', 'cleanup-profile-btn');

    // Add cleanup button handlers
    document.getElementById('cleanup-btn').addEventListener('click', function() {
        handleCleanup('host', 'cleanup-btn', 'cleanup-status-section', 'cleanup-messages');
    });

    document.getElementById('cleanup-profile-btn').addEventListener('click', function() {
        handleCleanup('profile-host', 'cleanup-profile-btn', 'cleanup-profile-status-section', 'cleanup-profile-messages');
    });

    // Handle profile selection
    document.getElementById('profile').addEventListener('change', function() {
        const manualInput = document.getElementById('manual-artifacts');
        const artifactsInput = document.getElementById('artifacts');
        
        if (this.value) {
            manualInput.style.display = 'none';
            artifactsInput.removeAttribute('required');
        } else {
            manualInput.style.display = 'block';
            artifactsInput.setAttribute('required', 'required');
        }
    });

    document.getElementById('process-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        // Explicitly handle the checkbox - always set to true regardless of checkbox state
        formData.set('build_collectors', 'true');
        
        // Disable the submit button and show processing state
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.classList.add('btn-processing');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        fetch('/start', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error:', data.error);
                alert('Error: ' + data.error);
                // Reset button on error
                submitBtn.disabled = false;
                submitBtn.classList.remove('btn-processing');
                submitBtn.innerHTML = '<i class="fas fa-play"></i> Start Processing';
            } else {
                console.log('Success:', data);
                // Start polling for status updates
                startStatusPolling();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error: ' + error);
            // Reset button on error
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-processing');
            submitBtn.innerHTML = '<i class="fas fa-play"></i> Start Processing';
        });
    });

    // Function to format JSON string
    function formatJSON(jsonString) {
        try {
            const obj = JSON.parse(jsonString);
            return JSON.stringify(obj, null, 2);
        } catch (e) {
            return jsonString; // Return original if not valid JSON
        }
    }

    // Function to toggle JSON content visibility
    function toggleJSON(button) {
        const jsonLine = button.closest('.json-line');
        jsonLine.classList.toggle('collapsed');
        button.innerHTML = jsonLine.classList.contains('collapsed') ? 
            '<i class="fas fa-plus"></i>' : 
            '<i class="fas fa-minus"></i>';
    }

    // Function to copy JSON content
    function copyJSON(button) {
        const content = button.closest('.json-line').querySelector('code').textContent;
        navigator.clipboard.writeText(content).then(() => {
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                button.innerHTML = originalHTML;
            }, 2000);
        });
    }

    async function updateStatus() {
        try {
            const response = await fetch('/status');
            const data = await response.json();

            // Update progress
            const progress = data.total_artifacts ? 
                Math.round((data.processed / data.total_artifacts) * 100) : 0;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-bar').textContent = `${progress}%`;
            
            // Update counts
            document.getElementById('processed-count').textContent = data.processed;
            document.getElementById('total-count').textContent = data.total_artifacts;
            document.getElementById('current-artifact').textContent = 
                data.current_artifact || '-';

            // Update messages
            const messagesDiv = document.getElementById('status-messages');
            messagesDiv.innerHTML = data.messages.map(msg => `
                <div class="status-message ${msg.type}">
                    <span class="timestamp">[${msg.timestamp}]</span>
                    <span class="message-content">${msg.message}</span>
                    <span class="elapsed-time">${msg.elapsed}</span>
                </div>
            `).join('');

            // Update statistics dashboard
            if (data.completed) {
                const statsSection = document.getElementById('stats-section');
                statsSection.style.display = 'block';
                
                // Update successful artifacts
                const successfulDiv = document.getElementById('successful-artifacts');
                successfulDiv.innerHTML = data.artifact_stats.successful.map(artifact => `
                    <div class="artifact-item">
                        <div class="artifact-info">
                            <i class="fas fa-check-circle"></i>
                            <span class="artifact-name">${artifact.name}</span>
                        </div>
                        <div class="artifact-meta">
                            <span class="execution-time">
                                <i class="fas fa-stopwatch"></i>
                                ${artifact.execution_time}s
                            </span>
                        </div>
                    </div>
                `).join('') || '<div class="artifact-item">No successful artifacts</div>';
                
                // Update failed artifacts
                const failedDiv = document.getElementById('failed-artifacts');
                failedDiv.innerHTML = data.artifact_stats.failed.map(artifact => `
                    <div class="artifact-item">
                        <div class="artifact-info">
                            <i class="fas fa-times-circle"></i>
                            <span class="artifact-name">${artifact.name}</span>
                        </div>
                        <div class="artifact-meta">
                            <span class="execution-time">
                                <i class="fas fa-stopwatch"></i>
                                ${artifact.execution_time}s
                            </span>
                        </div>
                    </div>
                `).join('') || '<div class="artifact-item">No failed artifacts</div>';

                // Update results section
                document.getElementById('results-section').style.display = 'block';
                document.getElementById('results-list').innerHTML = data.results.map(result => {
                    if (result.preview && result.preview.length > 0) {
                        const jsonLines = result.preview.map((line, index) => {
                            const formattedJSON = formatJSON(line);
                            return `
                                <div class="json-line">
                                    <div class="json-line-header">
                                        <button class="toggle-btn" onclick="toggleJSON(this)">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <span>Line ${index + 1}</span>
                                        <button class="copy-btn" onclick="copyJSON(this)">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <div class="json-line-content">
                                        <pre><code class="language-json">${formattedJSON}</code></pre>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        return `
                            <div class="file-item">
                                <i class="fas fa-file"></i> ${result.path}
                                <div class="json-preview">
                                    ${jsonLines}
                                </div>
                            </div>
                        `;
                    }
                    return `
                        <div class="file-item">
                            <i class="fas fa-file"></i> ${result.path}
                        </div>
                    `;
                }).join('');

                // Initialize syntax highlighting
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
                
                if (!data.processing) {
                    isProcessing = false;
                    const submitBtn = document.getElementById('submit-btn');
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('btn-processing');
                    submitBtn.innerHTML = '<i class="fas fa-play"></i> Start Processing';
                    return false; // Stop polling
                }
            }

            return true; // Continue polling
        } catch (error) {
            console.error('Error fetching status:', error);
            // Reset button on error during polling
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-processing');
            submitBtn.innerHTML = '<i class="fas fa-play"></i> Start Processing';
            return true; // Continue polling despite error
        }
    }

    function startStatusPolling() {
        const poll = async () => {
            if (await updateStatus()) {
                setTimeout(poll, 1000);
            }
        };
        poll();
    }

    // Function to show download status message
    function showDownloadStatus(message, type = 'info') {
        const statusDiv = $('#download-status');
        statusDiv
            .removeClass('info error')
            .addClass(type)
            .html(`<i class="fas ${type === 'info' ? 'fa-info-circle' : 'fa-exclamation-circle'}"></i> ${message}`)
            .show();
        
        // Log to console as well
        console.log(`Download Status (${type}):`, message);
    }

    // Function to update download button state
    function updateDownloadButton(data) {
        const downloadBtn = $('#download-collector-btn');
        console.log('Updating download button state with data:', data);
        
        if (data.completed && data.artifact_stats && 
            data.artifact_stats.successful && 
            data.artifact_stats.successful.length > 0) {
            console.log('Enabling download button - collector available');
            downloadBtn
                .prop('disabled', false)
                .addClass('enabled')
                .attr('title', 'Click to download the collector');
            showDownloadStatus('Collector is ready for download', 'info');
        } else {
            console.log('Disabling download button - collector not available');
            downloadBtn
                .prop('disabled', true)
                .removeClass('enabled')
                .attr('title', 'Collector not available');
            showDownloadStatus('Collector is not available yet', 'info');
        }
    }

    $(document).ready(function() {
        console.log('Initializing download button handlers');
        
        // Remove any existing click handlers and add new one
        $('#download-collector-btn').off('click').on('click', function(e) {
            e.preventDefault();
            console.log('Download button clicked');
            console.log('Button state:', {
                disabled: $(this).prop('disabled'),
                hasEnabledClass: $(this).hasClass('enabled')
            });

            if ($(this).hasClass('enabled')) {
                console.log('Button is enabled, initiating download...');
                showDownloadStatus('Starting collector download...', 'info');

                // Make an AJAX call first to check if the collector exists
                $.ajax({
                    url: '/download-collector',
                    method: 'GET',
                    success: function(response) {
                        console.log('Download check successful:', response);
                        // If we got a successful response, trigger the actual download
                        window.location.href = '/download-collector';
                        showDownloadStatus('Download started successfully', 'info');
                    },
                    error: function(xhr, status, error) {
                        console.error('Download check failed:', {xhr, status, error});
                        let errorMessage = 'Failed to download collector: ';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMessage += response.error || error;
                        } catch (e) {
                            errorMessage += error;
                        }
                        showDownloadStatus(errorMessage, 'error');
                    }
                });
            } else {
                console.log('Button is disabled, ignoring click');
                showDownloadStatus('Collector is not ready for download yet', 'error');
            }
        });

        // Update the start profile testing click handler
        $('#start-profile-testing').off('click').on('click', function() {
            console.log('Starting profile testing, resetting download button');
            $('#download-collector-btn')
                .prop('disabled', true)
                .removeClass('enabled')
                .attr('title', 'Processing in progress...');
            showDownloadStatus('Processing in progress...', 'info');
            
            const selectedProfile = document.querySelector('input[name="profile-selection"]:checked');
            
            if (!selectedProfile) {
                alert('Please select a profile to test.');
                return;
            }

            const host = document.getElementById('profile-host').value;
            if (!host) {
                alert('Please select a target host.');
                return;
            }

            const data = {
                profiles: [selectedProfile.value], // Backend expects an array of profile IDs
                host: host,
                buildCollectors: true  // Always set to true
            };

            // Disable the button and show loading state
            const button = this;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            fetch('/start-combinations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    alert('Error: ' + data.error);
                } else {
                    console.log('Success:', data);
                    // Reset UI elements
                    document.getElementById('profile-progress').style.display = 'none';
                    document.getElementById('profile-status-messages').style.display = 'none';
                    document.getElementById('profile-results').style.display = 'none';
                    // Start polling for status updates
                    startProfileStatusPolling();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error);
            })
            .finally(() => {
                // Re-enable the button and restore original text
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-play"></i> Start Profile Testing';
            });
        });

        // Update the cleanup button click handler
        $('#cleanup-profile-btn').off('click').on('click', function() {
            console.log('Starting cleanup, resetting download button');
            $('#download-collector-btn')
                .prop('disabled', true)
                .removeClass('enabled')
                .attr('title', 'Cleanup in progress...');
            showDownloadStatus('Cleanup in progress...', 'info');
            handleCleanup('profile-host', 'cleanup-profile-btn', 'cleanup-profile-status-section', 'cleanup-profile-messages');
        });
    });

    // Update the existing updateProfileStatus function
    async function updateProfileStatus() {
        try {
            const response = await fetch('/profile-status');
            const data = await response.json();
            console.log('Profile status update received:', data);

            // Show all sections
            document.getElementById('profile-progress').style.display = 'block';
            document.getElementById('profile-status-messages').style.display = 'block';
            document.getElementById('profile-statistics').style.display = 'block';

            // Update progress bar
            const progress = data.total_artifacts ? 
                Math.round((data.processed_artifacts / data.total_artifacts) * 100) : 0;
            document.getElementById('profile-progress-bar').style.width = `${progress}%`;
            document.getElementById('profile-progress-bar').textContent = `${progress}%`;

            // Update statistics if available
            if (data.statistics) {
                document.getElementById('profile-artifacts-processed').textContent = data.statistics.artifacts_processed;
                document.getElementById('profile-success-rate').textContent = `${data.statistics.success_rate}%`;
                document.getElementById('profile-total-time').textContent = `${data.statistics.total_execution_time}s`;
                document.getElementById('profile-avg-time').textContent = `${data.statistics.average_execution_time}s`;
            }

            // Update status messages
            const messagesContainer = document.getElementById('profile-messages-container');
            messagesContainer.innerHTML = data.messages.map(msg => `
                <div class="status-message ${msg.type || 'info'}">
                    <span class="timestamp">[${msg.timestamp}]</span>
                    <span class="message-content">${msg.message}</span>
                    ${msg.elapsed ? `<span class="elapsed-time">${msg.elapsed}</span>` : ''}
                </div>
            `).join('');

            // Auto-scroll to the bottom of the messages container
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Update download button state
            updateDownloadButton(data);

            // If processing is complete, show results
            if (data.completed && data.artifact_results && data.artifact_results.length > 0) {
                document.getElementById('profile-results').style.display = 'block';
                const result = data.artifact_results[0];
                
                // Update results content
                document.getElementById('profile-results-content').innerHTML = `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Test Run at ${result.timestamp}</h6>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>Successful Artifacts (${result.stats.successful.length})</h6>
                                    <div class="artifact-list">
                                        ${result.stats.successful.map(artifact => `
                                            <div class="artifact-item">
                                                <div class="artifact-info">
                                                    <i class="fas fa-check-circle text-success"></i>
                                                    <span class="artifact-name">${artifact.name}</span>
                                                </div>
                                                <div class="artifact-meta">
                                                    <span class="execution-time">
                                                        <i class="fas fa-stopwatch"></i>
                                                        ${artifact.execution_time}s
                                                    </span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Failed Artifacts (${result.stats.failed.length})</h6>
                                    <div class="artifact-list">
                                        ${result.stats.failed.map(artifact => `
                                            <div class="artifact-item">
                                                <div class="artifact-info">
                                                    <i class="fas fa-times-circle text-danger"></i>
                                                    <span class="artifact-name">${artifact.name}</span>
                                                </div>
                                                <div class="artifact-meta">
                                                    <span class="execution-time">
                                                        <i class="fas fa-stopwatch"></i>
                                                        ${artifact.execution_time}s
                                                    </span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                console.log('Processing completed, final button state update');
                return false; // Stop polling
            }
            return true; // Continue polling
        } catch (error) {
            console.error('Error fetching profile status:', error);
            showDownloadStatus('Error checking profile status: ' + error, 'error');
            return true; // Continue polling despite error
        }
    }

    // Function to start profile status polling
    function startProfileStatusPolling() {
        const poll = async () => {
            if (await updateProfileStatus()) {
                setTimeout(poll, 1000);
            }
        };
        poll();
    }
</script>
{% endblock %} 