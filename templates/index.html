<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velo The Helo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <style>
        body {
            padding-top: 60px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-message {
            padding: 5px 10px;
            margin: 2px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .status-message.error {
            background-color: #ffebee;
            color: #c62828;
        }
        .status-message.info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }
        .status-message .timestamp {
            font-weight: bold;
            margin-right: 10px;
        }
        .status-message .elapsed-time {
            color: #666;
            font-style: italic;
            margin-left: 10px;
        }
        .status-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .timestamp {
            color: #6c757d;
            margin-right: 10px;
            font-family: monospace;
        }
        .elapsed-time {
            color: #28a745;
            font-family: monospace;
            font-size: 0.9em;
            float: right;
        }
        .message-content {
            display: inline-block;
            margin-right: 10px;
        }
        .file-item {
            padding: 10px;
            border: 1px solid #dee2e6;
            margin: 5px 0;
            border-radius: 4px;
            background-color: white;
        }
        .file-item i {
            margin-right: 10px;
            color: #6c757d;
        }
        .json-preview {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .json-line {
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .json-line pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .json-line code {
            padding: 0 !important;
            background: transparent !important;
        }
        .json-line-header {
            padding: 5px;
            margin-bottom: 5px;
            color: #6c757d;
            font-size: 0.9em;
            border-bottom: 1px solid #dee2e6;
        }
        .json-line-content {
            padding: 5px;
        }
        .copy-btn {
            float: right;
            padding: 2px 8px;
            font-size: 0.8em;
            color: #6c757d;
            background: transparent;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            cursor: pointer;
        }
        .copy-btn:hover {
            background-color: #f8f9fa;
        }
        .toggle-btn {
            padding: 2px 8px;
            margin-right: 5px;
            font-size: 0.8em;
            color: #6c757d;
            background: transparent;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            cursor: pointer;
        }
        .toggle-btn:hover {
            background-color: #f8f9fa;
        }
        .collapsed .json-line-content {
            display: none;
        }
        #status-messages {
            max-height: 300px;
            overflow-y: auto;
        }
        .results-list {
            max-height: 400px;
            overflow-y: auto;
        }
        #progress-bar {
            height: 20px;
        }
        .artifact-list {
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }
        .artifact-item {
            padding: 8px;
            margin: 4px 0;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .artifact-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .artifact-name {
            font-weight: bold;
        }
        .artifact-meta {
            font-size: 0.85em;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .execution-time {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        /* New styles for combinations tab */
        .selected-artifacts {
            min-height: 100px;
            border: 2px dashed #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .artifact-chip {
            display: inline-block;
            padding: 5px 10px;
            margin: 3px;
            background-color: #e9ecef;
            border-radius: 15px;
            font-size: 0.9em;
        }
        .artifact-chip .remove-artifact {
            margin-left: 5px;
            cursor: pointer;
            color: #dc3545;
        }
        .artifact-search {
            margin-bottom: 15px;
        }
        .artifact-suggestions {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            display: none;
        }
        .artifact-suggestion {
            padding: 8px 15px;
            cursor: pointer;
        }
        .artifact-suggestion:hover {
            background-color: #f8f9fa;
        }
        /* Add new styles for processing button */
        .btn-processing {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            color: white !important;
            cursor: not-allowed;
        }
        /* Add new styles for download button */
        .btn-download-collector {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
            cursor: not-allowed;
        }
        .btn-download-collector.enabled {
            background-color: #0d6efd;
            border-color: #0d6efd;
            cursor: pointer;
        }
        /* Add styles for download status messages */
        .download-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .download-status.info {
            background-color: #e3f2fd;
            color: #0d47a1;
            border: 1px solid #90caf9;
        }
        .download-status.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="https://github.com/M507/velo_the_helo">Velo The Helo</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="nav nav-pills">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="pill" href="#test-individual">Test Individually</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="pill" href="#test-profiles">Test Profiles</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Individual Testing Tab -->
            <div class="tab-pane fade show active" id="test-individual">
                <h1 class="mb-4">Artifact Processor</h1>
                
                <!-- Input Form -->
                <div class="card">
                    <div class="card-body">
                        <form id="process-form">
                            <div class="mb-3">
                                <label for="profile" class="form-label">Select Profile</label>
                                <select class="form-select mb-3" id="profile" name="profile">
                                    <option value="">Custom (Manual Input)</option>
                                    {% for profile in profiles %}
                                    <option value="{{ profile.id }}">{{ profile.name }} - {{ profile.description }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="host" class="form-label">Select Target Host</label>
                                <select class="form-select mb-3" id="host" name="host" required>
                                    <option value="">Select a host...</option>
                                    <option value="win10">Windows 10</option>
                                    <option value="win11">Windows 11</option>
                                    <option value="winserver12">Windows Server 2012</option>
                                    <option value="winserver16">Windows Server 2016</option>
                                    <option value="winserver19">Windows Server 2019</option>
                                    <option value="winserver22">Windows Server 2022</option>
                                    <option value="winserver25">Windows Server 2025</option>
                                </select>
                            </div>
                            <div class="mb-3" id="manual-artifacts">
                                <label for="artifacts" class="form-label">Artifacts (comma-separated)</label>
                                <input type="text" class="form-control" id="artifacts" name="artifacts"
                                       placeholder="e.g., Windows.System.PowerShell,Windows.Sys.Users">
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="build-collectors" name="build_collectors" value="true" checked disabled>
                                <label class="form-check-label" for="build-collectors">Build Collectors</label>
                            </div>
                            <div class="btn-group">
                                <button type="submit" class="btn btn-primary" id="submit-btn">
                                    <i class="fas fa-play"></i> Start Processing
                                </button>
                                <button type="button" class="btn btn-warning" id="cleanup-btn" disabled>
                                    <i class="fas fa-broom"></i> Cleanup
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Cleanup Status Section -->
                <div class="card" id="cleanup-status-section" style="display: none;">
                    <div class="card-body">
                        <h5 class="card-title">Cleanup Status</h5>
                        <div id="cleanup-messages" class="status-messages"></div>
                    </div>
                </div>

                <!-- Progress Section -->
                <div class="card" id="progress-section" style="display: none;">
                    <div class="card-body">
                        <h5 class="card-title">Progress</h5>
                        <div class="progress mb-3">
                            <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%">0%</div>
                        </div>
                        <p class="mb-2">Current Artifact: <span id="current-artifact">-</span></p>
                        <p class="mb-2">Processed: <span id="processed-count">0</span> / <span id="total-count">0</span></p>
                    </div>
                </div>

                <!-- Status Messages -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Status Messages</h5>
                        <div id="status-messages" class="mb-3"></div>
                    </div>
                </div>

                <!-- Statistics Dashboard -->
                <div class="card" id="stats-section" style="display: none;">
                    <div class="card-body">
                        <h5 class="card-title">Artifact Processing Statistics</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-success text-white mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Successful Artifacts</h6>
                                        <div id="successful-artifacts" class="artifact-list"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-danger text-white mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Failed Artifacts</h6>
                                        <div id="failed-artifacts" class="artifact-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="card" id="results-section" style="display: none;">
                    <div class="card-body">
                        <h5 class="card-title">Results</h5>
                        <div id="results-list" class="results-list"></div>
                    </div>
                </div>
            </div>

            <!-- Profiles Testing Tab -->
            <div class="tab-pane fade" id="test-profiles">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Test Complete Profiles</h5>
                        
                        <!-- Host Selection -->
                        <div class="mb-3">
                            <label for="profile-host" class="form-label">Select Target Host</label>
                            <select class="form-select" id="profile-host" required>
                                <option value="">Select a host...</option>
                                <option value="win10">Windows 10</option>
                                <option value="win11">Windows 11</option>
                                <option value="winserver12">Windows Server 2012</option>
                                <option value="winserver16">Windows Server 2016</option>
                                <option value="winserver19">Windows Server 2019</option>
                                <option value="winserver22">Windows Server 2022</option>
                                <option value="winserver25">Windows Server 2025</option>
                            </select>
                        </div>

                        <!-- Profile Selection -->
                        <div class="mb-3">
                            <label class="form-label">Select Profile to Test</label>
                            <div class="profile-selection">
                                {% for profile in profiles %}
                                <div class="form-check">
                                    <input type="radio" class="form-check-input profile-radio" name="profile-selection" id="profile-{{ profile.id }}" value="{{ profile.id }}">
                                    <label class="form-check-label" for="profile-{{ profile.id }}">
                                        {{ profile.name }} - {{ profile.description }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Profile Testing Options -->
                        <div class="mb-3">
                            <label class="form-label">Testing Settings</label>
                            <div class="form-check mb-2">
                                <input type="checkbox" class="form-check-input" id="build-collectors-profile" checked disabled>
                                <label class="form-check-label" for="build-collectors-profile">
                                    Build Collectors
                                </label>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button type="button" class="btn btn-primary" id="start-profile-testing">
                                <i class="fas fa-play"></i> Start Profile Testing
                            </button>
                            <button type="button" class="btn btn-warning" id="cleanup-profile-btn" disabled>
                                <i class="fas fa-broom"></i> Cleanup
                            </button>
                            <button type="button" class="btn btn-download-collector" id="download-collector-btn" disabled>
                                <i class="fas fa-download"></i> Download Collector
                            </button>
                        </div>
                        <!-- Add download status message div -->
                        <div id="download-status" class="download-status"></div>
                    </div>
                </div>

                <!-- Cleanup Status Section for Profile Testing -->
                <div class="card" id="cleanup-profile-status-section" style="display: none;">
                    <div class="card-body">
                        <h5 class="card-title">Cleanup Status</h5>
                        <div id="cleanup-profile-messages" class="status-messages"></div>
                    </div>
                </div>

                <!-- Progress Section -->
                <div id="profile-progress" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Processing Progress</h5>
                            <div class="progress mb-3">
                                <div id="profile-progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Dashboard -->
                <div id="profile-statistics" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Processing Statistics</h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <div class="stat-label">Artifacts Processed</div>
                                        <div class="stat-value" id="profile-artifacts-processed">0</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <div class="stat-label">Success Rate</div>
                                        <div class="stat-value" id="profile-success-rate">0%</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <div class="stat-label">Total Execution Time</div>
                                        <div class="stat-value" id="profile-total-time">0s</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <div class="stat-label">Average Execution Time</div>
                                        <div class="stat-value" id="profile-avg-time">0s</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Messages -->
                <div id="profile-status-messages" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Status Messages</h5>
                            <div class="status-messages" id="profile-messages-container">
                                <!-- Status messages will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="profile-results" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Results</h5>
                            <div id="profile-results-content">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Profile Tab -->
            <div id="test-profile-tab" class="tab-pane fade">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Test Profile Status</h5>
                                </div>
                                <div class="card-body">
                                    <div class="progress mb-3">
                                        <div id="test-profile-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                    </div>
                                    <div id="test-profile-status" class="status-messages">
                                        <!-- Status messages will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Add highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/json.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        let isProcessing = false;

        // Function to display cleanup messages
        function displayCleanupMessages(messages, errors, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            // Add status messages
            messages.forEach(message => {
                container.innerHTML += `
                    <div class="status-message info">
                        <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                        <span class="message-content"><i class="fas fa-info-circle"></i> ${message}</span>
                    </div>
                `;
            });

            // Add error messages if any
            errors.forEach(error => {
                container.innerHTML += `
                    <div class="status-message error">
                        <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                        <span class="message-content"><i class="fas fa-exclamation-circle"></i> ${error}</span>
                    </div>
                `;
            });

            // Scroll to the bottom of the messages
            container.scrollTop = container.scrollHeight;
        }

        // Function to handle cleanup for both tabs
        function handleCleanup(hostSelectId, cleanupBtnId, statusSectionId, messagesContainerId) {
            const host = document.getElementById(hostSelectId).value;
            if (!host) {
                alert('Please select a target host before cleanup');
                return;
            }

            // Show the status section
            document.getElementById(statusSectionId).style.display = 'block';
            const messagesContainer = document.getElementById(messagesContainerId);
            messagesContainer.innerHTML = `
                <div class="status-message info">
                    <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                    <span class="message-content"><i class="fas fa-spinner fa-spin"></i> Starting cleanup...</span>
                </div>
            `;

            // Disable the cleanup button and show cleaning state
            const cleanupBtn = document.getElementById(cleanupBtnId);
            cleanupBtn.disabled = true;
            cleanupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cleaning...';

            fetch('/cleanup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ host: host })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'error') {
                    console.error('Cleanup errors:', data.errors);
                    displayCleanupMessages(data.messages, data.errors, messagesContainerId);
                } else {
                    console.log('Cleanup success:', data.messages);
                    displayCleanupMessages(data.messages, [], messagesContainerId);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                displayCleanupMessages([], [`Error during cleanup: ${error}`], messagesContainerId);
            })
            .finally(() => {
                // Re-enable the cleanup button and restore original text
                cleanupBtn.disabled = false;
                cleanupBtn.innerHTML = '<i class="fas fa-broom"></i> Cleanup';
            });
        }

        // Function to handle host selection for cleanup buttons
        function handleHostSelection(hostSelectId, cleanupBtnId) {
            const hostSelect = document.getElementById(hostSelectId);
            const cleanupBtn = document.getElementById(cleanupBtnId);
            
            hostSelect.addEventListener('change', function() {
                cleanupBtn.disabled = !this.value;
            });
        }

        // Initialize host selection handlers for both tabs
        handleHostSelection('host', 'cleanup-btn');
        handleHostSelection('profile-host', 'cleanup-profile-btn');

        // Add cleanup button handlers
        document.getElementById('cleanup-btn').addEventListener('click', function() {
            handleCleanup('host', 'cleanup-btn', 'cleanup-status-section', 'cleanup-messages');
        });

        document.getElementById('cleanup-profile-btn').addEventListener('click', function() {
            handleCleanup('profile-host', 'cleanup-profile-btn', 'cleanup-profile-status-section', 'cleanup-profile-messages');
        });

        // Handle profile selection
        document.getElementById('profile').addEventListener('change', function() {
            const manualInput = document.getElementById('manual-artifacts');
            const artifactsInput = document.getElementById('artifacts');
            
            if (this.value) {
                manualInput.style.display = 'none';
                artifactsInput.removeAttribute('required');
            } else {
                manualInput.style.display = 'block';
                artifactsInput.setAttribute('required', 'required');
            }
        });

        document.getElementById('process-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Explicitly handle the checkbox - always set to true regardless of checkbox state
            formData.set('build_collectors', 'true');
            
            // Disable the submit button and show processing state
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.classList.add('btn-processing');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            fetch('/start', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    alert('Error: ' + data.error);
                    // Reset button on error
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('btn-processing');
                    submitBtn.innerHTML = '<i class="fas fa-play"></i> Start Processing';
                } else {
                    console.log('Success:', data);
                    // Start polling for status updates
                    startStatusPolling();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error);
                // Reset button on error
                submitBtn.disabled = false;
                submitBtn.classList.remove('btn-processing');
                submitBtn.innerHTML = '<i class="fas fa-play"></i> Start Processing';
            });
        });

        // Function to format JSON string
        function formatJSON(jsonString) {
            try {
                const obj = JSON.parse(jsonString);
                return JSON.stringify(obj, null, 2);
            } catch (e) {
                return jsonString; // Return original if not valid JSON
            }
        }

        // Function to toggle JSON content visibility
        function toggleJSON(button) {
            const jsonLine = button.closest('.json-line');
            jsonLine.classList.toggle('collapsed');
            button.innerHTML = jsonLine.classList.contains('collapsed') ? 
                '<i class="fas fa-plus"></i>' : 
                '<i class="fas fa-minus"></i>';
        }

        // Function to copy JSON content
        function copyJSON(button) {
            const content = button.closest('.json-line').querySelector('code').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                }, 2000);
            });
        }

        async function updateStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();

                // Update progress
                const progress = data.total_artifacts ? 
                    Math.round((data.processed / data.total_artifacts) * 100) : 0;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('progress-bar').textContent = `${progress}%`;
                
                // Update counts
                document.getElementById('processed-count').textContent = data.processed;
                document.getElementById('total-count').textContent = data.total_artifacts;
                document.getElementById('current-artifact').textContent = 
                    data.current_artifact || '-';

                // Update messages
                const messagesDiv = document.getElementById('status-messages');
                messagesDiv.innerHTML = data.messages.map(msg => `
                    <div class="status-message ${msg.type}">
                        <span class="timestamp">[${msg.timestamp}]</span>
                        <span class="message-content">${msg.message}</span>
                        <span class="elapsed-time">${msg.elapsed}</span>
                    </div>
                `).join('');

                // Update statistics dashboard
                if (data.completed) {
                    const statsSection = document.getElementById('stats-section');
                    statsSection.style.display = 'block';
                    
                    // Update successful artifacts
                    const successfulDiv = document.getElementById('successful-artifacts');
                    successfulDiv.innerHTML = data.artifact_stats.successful.map(artifact => `
                        <div class="artifact-item">
                            <div class="artifact-info">
                                <i class="fas fa-check-circle"></i>
                                <span class="artifact-name">${artifact.name}</span>
                            </div>
                            <div class="artifact-meta">
                                <span class="execution-time">
                                    <i class="fas fa-stopwatch"></i>
                                    ${artifact.execution_time}s
                                </span>
                            </div>
                        </div>
                    `).join('') || '<div class="artifact-item">No successful artifacts</div>';
                    
                    // Update failed artifacts
                    const failedDiv = document.getElementById('failed-artifacts');
                    failedDiv.innerHTML = data.artifact_stats.failed.map(artifact => `
                        <div class="artifact-item">
                            <div class="artifact-info">
                                <i class="fas fa-times-circle"></i>
                                <span class="artifact-name">${artifact.name}</span>
                            </div>
                            <div class="artifact-meta">
                                <span class="execution-time">
                                    <i class="fas fa-stopwatch"></i>
                                    ${artifact.execution_time}s
                                </span>
                            </div>
                        </div>
                    `).join('') || '<div class="artifact-item">No failed artifacts</div>';

                    // Update results section
                    document.getElementById('results-section').style.display = 'block';
                    document.getElementById('results-list').innerHTML = data.results.map(result => {
                        if (result.preview && result.preview.length > 0) {
                            const jsonLines = result.preview.map((line, index) => {
                                const formattedJSON = formatJSON(line);
                                return `
                                    <div class="json-line">
                                        <div class="json-line-header">
                                            <button class="toggle-btn" onclick="toggleJSON(this)">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <span>Line ${index + 1}</span>
                                            <button class="copy-btn" onclick="copyJSON(this)">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <div class="json-line-content">
                                            <pre><code class="language-json">${formattedJSON}</code></pre>
                                        </div>
                                    </div>
                                `;
                            }).join('');

                            return `
                                <div class="file-item">
                                    <i class="fas fa-file"></i> ${result.path}
                                    <div class="json-preview">
                                        ${jsonLines}
                                    </div>
                                </div>
                            `;
                        }
                        return `
                            <div class="file-item">
                                <i class="fas fa-file"></i> ${result.path}
                            </div>
                        `;
                    }).join('');

                    // Initialize syntax highlighting
                    document.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightBlock(block);
                    });
                    
                    if (!data.processing) {
                        isProcessing = false;
                        const submitBtn = document.getElementById('submit-btn');
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('btn-processing');
                        submitBtn.innerHTML = '<i class="fas fa-play"></i> Start Processing';
                        return false; // Stop polling
                    }
                }

                return true; // Continue polling
            } catch (error) {
                console.error('Error fetching status:', error);
                // Reset button on error during polling
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = false;
                submitBtn.classList.remove('btn-processing');
                submitBtn.innerHTML = '<i class="fas fa-play"></i> Start Processing';
                return true; // Continue polling despite error
            }
        }

        function startStatusPolling() {
            const poll = async () => {
                if (await updateStatus()) {
                    setTimeout(poll, 1000);
                }
            };
            poll();
        }

        // New JavaScript for combinations tab
        document.addEventListener('DOMContentLoaded', function() {
            const selectedArtifacts = new Set();
            const artifactSearch = document.getElementById('artifact-search');
            const artifactSuggestions = document.getElementById('artifact-suggestions');
            const selectedArtifactsContainer = document.getElementById('selected-artifacts');

            // Function to add artifact chip
            function addArtifactChip(artifact) {
                if (!selectedArtifacts.has(artifact)) {
                    selectedArtifacts.add(artifact);
                    const chip = document.createElement('span');
                    chip.className = 'artifact-chip';
                    chip.innerHTML = `
                        ${artifact}
                        <span class="remove-artifact" onclick="removeArtifact('${artifact}')">
                            <i class="fas fa-times"></i>
                        </span>
                    `;
                    selectedArtifactsContainer.appendChild(chip);
                }
                artifactSearch.value = '';
                artifactSuggestions.style.display = 'none';
            }

            // Function to remove artifact chip
            window.removeArtifact = function(artifact) {
                selectedArtifacts.delete(artifact);
                const chips = selectedArtifactsContainer.getElementsByClassName('artifact-chip');
                for (let chip of chips) {
                    if (chip.textContent.trim() === artifact) {
                        chip.remove();
                        break;
                    }
                }
            };

            // Handle artifact search
            artifactSearch.addEventListener('input', function() {
                const searchTerm = this.value.trim().toLowerCase();
                if (searchTerm.length < 2) {
                    artifactSuggestions.style.display = 'none';
                    return;
                }

                // TODO: Replace with actual artifact list from backend
                const mockArtifacts = [
                    'Windows.System.PowerShell',
                    'Windows.System.ProcessList',
                    'Windows.Network.NetstatEnriched',
                    'Windows.System.Services',
                    // Add more artifacts here
                ];

                const matches = mockArtifacts.filter(a => 
                    a.toLowerCase().includes(searchTerm) && !selectedArtifacts.has(a)
                );

                if (matches.length > 0) {
                    artifactSuggestions.innerHTML = matches.map(artifact => `
                        <div class="artifact-suggestion" onclick="addArtifactChip('${artifact}')">
                            ${artifact}
                        </div>
                    `).join('');
                    artifactSuggestions.style.display = 'block';
                } else {
                    artifactSuggestions.style.display = 'none';
                }
            });

            // Handle start combinations testing
            document.getElementById('start-combinations').addEventListener('click', function() {
                const host = document.getElementById('combo-host').value;
                const testAllCombinations = document.getElementById('test-all-combinations').checked;
                const sequentialExecution = document.getElementById('sequential-execution').checked;
                const buildCollectors = document.getElementById('build-collectors-combo').checked;

                if (!host) {
                    alert('Please select a target host');
                    return;
                }

                if (selectedArtifacts.size === 0) {
                    alert('Please select at least one artifact');
                    return;
                }

                // TODO: Implement the actual combination testing logic
                console.log('Starting combination testing with:', {
                    host,
                    artifacts: Array.from(selectedArtifacts),
                    testAllCombinations,
                    sequentialExecution,
                    buildCollectors
                });

                // Show progress section
                document.getElementById('combinations-progress').style.display = 'block';
            });
        });

        // Function to add artifact chip
        window.addArtifactChip = function(artifact) {
            const selectedArtifacts = new Set(
                Array.from(document.getElementsByClassName('artifact-chip'))
                    .map(chip => chip.getAttribute('data-artifact'))
            );
            
            if (!selectedArtifacts.has(artifact)) {
                const chip = document.createElement('span');
                chip.className = 'artifact-chip';
                chip.setAttribute('data-artifact', artifact);
                chip.innerHTML = `
                    ${artifact}
                    <span class="remove-artifact" onclick="removeArtifact('${artifact}')">
                        <i class="fas fa-times"></i>
                    </span>
                `;
                document.getElementById('selected-artifacts').appendChild(chip);
            }
            document.getElementById('artifact-search').value = '';
            document.getElementById('artifact-suggestions').style.display = 'none';
        };

        // Function to remove artifact chip
        window.removeArtifact = function(artifact) {
            const chips = document.getElementsByClassName('artifact-chip');
            for (let chip of chips) {
                if (chip.getAttribute('data-artifact') === artifact) {
                    chip.remove();
                    break;
                }
            }
        };

        // Handle artifact search
        document.getElementById('artifact-search')?.addEventListener('input', function() {
            const searchTerm = this.value.trim().toLowerCase();
            const artifactSuggestions = document.getElementById('artifact-suggestions');
            
            if (searchTerm.length < 2) {
                artifactSuggestions.style.display = 'none';
                return;
            }

            // Get currently selected artifacts
            const selectedArtifacts = new Set(
                Array.from(document.getElementsByClassName('artifact-chip'))
                    .map(chip => chip.getAttribute('data-artifact'))
            );

            // TODO: Replace with actual artifact list from backend
            const mockArtifacts = [
                'Windows.System.PowerShell',
                'Windows.System.ProcessList',
                'Windows.Network.NetstatEnriched',
                'Windows.System.Services',
                'Windows.System.Drivers',
                'Windows.System.Registry',
                'Windows.Network.DNS',
                'Windows.System.Memory',
                'Windows.System.EventLogs'
            ];

            const matches = mockArtifacts.filter(a => 
                a.toLowerCase().includes(searchTerm) && !selectedArtifacts.has(a)
            );

            if (matches.length > 0) {
                artifactSuggestions.innerHTML = matches.map(artifact => `
                    <div class="artifact-suggestion" onclick="addArtifactChip('${artifact}')">
                        ${artifact}
                    </div>
                `).join('');
                artifactSuggestions.style.display = 'block';
            } else {
                artifactSuggestions.style.display = 'none';
            }
        });

        // Handle start combinations testing
        document.getElementById('start-combinations')?.addEventListener('click', function() {
            const host = document.getElementById('combo-host').value;
            const testAllCombinations = document.getElementById('test-all-combinations').checked;
            const sequentialExecution = document.getElementById('sequential-execution').checked;
            const buildCollectors = document.getElementById('build-collectors-combo').checked;

            // Get selected profiles
            const selectedProfiles = Array.from(document.getElementsByClassName('profile-checkbox'))
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);

            if (!host) {
                alert('Please select a target host');
                return;
            }

            if (selectedProfiles.length === 0) {
                alert('Please select at least one profile');
                return;
            }

            // Disable the button and show loading state
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            // Start the combination testing
            fetch('/start-combinations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    host,
                    profiles: selectedProfiles,
                    testAllCombinations,
                    sequentialExecution,
                    buildCollectors
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    alert('Error: ' + data.error);
                } else {
                    console.log('Success:', data);
                    startCombinationsStatusPolling();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error);
            })
            .finally(() => {
                // Re-enable the button and restore original text
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-play"></i> Start Combination Testing';
            });
        });

        function startCombinationsStatusPolling() {
            const progressSection = document.getElementById('combinations-progress');
            const resultsSection = document.getElementById('combinations-results');
            progressSection.style.display = 'block';

            const poll = async () => {
                try {
                    const response = await fetch('/combinations-status');
                    const data = await response.json();

                    // Update progress
                    const progress = data.total_combinations ? 
                        Math.round((data.processed_combinations / data.total_combinations) * 100) : 0;
                    document.getElementById('combinations-progress-bar').style.width = `${progress}%`;
                    document.getElementById('combinations-progress-bar').textContent = `${progress}%`;

                    // Update status messages
                    const statusDiv = document.getElementById('combinations-status');
                    statusDiv.innerHTML = data.messages.map(msg => `
                        <div class="status-message ${msg.type}">
                            <span class="timestamp">[${msg.timestamp}]</span>
                            <span class="message-content">${msg.message}</span>
                            <span class="elapsed-time">${msg.elapsed}</span>
                        </div>
                    `).join('');

                    // Update results if completed
                    if (data.completed) {
                        resultsSection.style.display = 'block';
                        const resultsContent = document.getElementById('combinations-results-content');
                        resultsContent.innerHTML = data.combination_results.map(result => `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        Combination: ${result.artifacts.join(', ')}
                                        <span class="badge ${result.success ? 'bg-success' : 'bg-danger'} float-end">
                                            ${result.success ? 'Success' : 'Failed'}
                                        </span>
                                    </h6>
                                    <p class="card-text">
                                        <small class="text-muted">Tested at: ${result.timestamp}</small>
                                    </p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Successful Artifacts</h6>
                                            <ul class="list-unstyled">
                                                ${result.stats.successful.map(artifact => `
                                                    <li>
                                                        <i class="fas fa-check-circle text-success"></i>
                                                        ${artifact.name} (${artifact.execution_time}s)
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Failed Artifacts</h6>
                                            <ul class="list-unstyled">
                                                ${result.stats.failed.map(artifact => `
                                                    <li>
                                                        <i class="fas fa-times-circle text-danger"></i>
                                                        ${artifact.name} (${artifact.execution_time}s)
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('');

                        return false; // Stop polling
                    }

                    return true; // Continue polling
                } catch (error) {
                    console.error('Error fetching combinations status:', error);
                    return true; // Continue polling despite error
                }
            };

            setTimeout(poll, 1000);
        }

        // Function to start profile testing
        document.getElementById('start-profile-testing').addEventListener('click', function() {
            const selectedProfile = document.querySelector('input[name="profile-selection"]:checked');
            
            if (!selectedProfile) {
                alert('Please select a profile to test.');
                return;
            }

            const host = document.getElementById('profile-host').value;
            if (!host) {
                alert('Please select a target host.');
                return;
            }

            const data = {
                profiles: [selectedProfile.value], // Backend expects an array of profile IDs
                host: host,
                buildCollectors: true  // Always set to true
            };

            // Disable the button and show loading state
            const button = this;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            fetch('/start-combinations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    alert('Error: ' + data.error);
                } else {
                    console.log('Success:', data);
                    // Reset UI elements
                    document.getElementById('profile-progress').style.display = 'none';
                    document.getElementById('profile-status-messages').style.display = 'none';
                    document.getElementById('profile-results').style.display = 'none';
                    // Start polling for status updates
                    startProfileStatusPolling();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error);
            })
            .finally(() => {
                // Re-enable the button and restore original text
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-play"></i> Start Profile Testing';
            });
        });

        // Function to show download status message
        function showDownloadStatus(message, type = 'info') {
            const statusDiv = $('#download-status');
            statusDiv
                .removeClass('info error')
                .addClass(type)
                .html(`<i class="fas ${type === 'info' ? 'fa-info-circle' : 'fa-exclamation-circle'}"></i> ${message}`)
                .show();
            
            // Log to console as well
            console.log(`Download Status (${type}):`, message);
        }

        // Function to update download button state
        function updateDownloadButton(data) {
            const downloadBtn = $('#download-collector-btn');
            console.log('Updating download button state with data:', data);
            
            if (data.completed && data.artifact_stats && 
                data.artifact_stats.successful && 
                data.artifact_stats.successful.length > 0) {
                console.log('Enabling download button - collector available');
                downloadBtn
                    .prop('disabled', false)
                    .addClass('enabled')
                    .attr('title', 'Click to download the collector');
                showDownloadStatus('Collector is ready for download', 'info');
            } else {
                console.log('Disabling download button - collector not available');
                downloadBtn
                    .prop('disabled', true)
                    .removeClass('enabled')
                    .attr('title', 'Collector not available');
                showDownloadStatus('Collector is not available yet', 'info');
            }
        }

        $(document).ready(function() {
            console.log('Initializing download button handlers');
            
            // Remove any existing click handlers and add new one
            $('#download-collector-btn').off('click').on('click', function(e) {
                e.preventDefault();
                console.log('Download button clicked');
                console.log('Button state:', {
                    disabled: $(this).prop('disabled'),
                    hasEnabledClass: $(this).hasClass('enabled')
                });

                if ($(this).hasClass('enabled')) {
                    console.log('Button is enabled, initiating download...');
                    showDownloadStatus('Starting collector download...', 'info');

                    // Make an AJAX call first to check if the collector exists
                    $.ajax({
                        url: '/download-collector',
                        method: 'GET',
                        success: function(response) {
                            console.log('Download check successful:', response);
                            // If we got a successful response, trigger the actual download
                            window.location.href = '/download-collector';
                            showDownloadStatus('Download started successfully', 'info');
                        },
                        error: function(xhr, status, error) {
                            console.error('Download check failed:', {xhr, status, error});
                            let errorMessage = 'Failed to download collector: ';
                            try {
                                const response = JSON.parse(xhr.responseText);
                                errorMessage += response.error || error;
                            } catch (e) {
                                errorMessage += error;
                            }
                            showDownloadStatus(errorMessage, 'error');
                        }
                    });
                } else {
                    console.log('Button is disabled, ignoring click');
                    showDownloadStatus('Collector is not ready for download yet', 'error');
                }
            });

            // Update the start profile testing click handler
            $('#start-profile-testing').off('click').on('click', function() {
                console.log('Starting profile testing, resetting download button');
                $('#download-collector-btn')
                    .prop('disabled', true)
                    .removeClass('enabled')
                    .attr('title', 'Processing in progress...');
                showDownloadStatus('Processing in progress...', 'info');
                // ... rest of your existing start profile testing code ...
            });

            // Update the cleanup button click handler
            $('#cleanup-profile-btn').off('click').on('click', function() {
                console.log('Starting cleanup, resetting download button');
                $('#download-collector-btn')
                    .prop('disabled', true)
                    .removeClass('enabled')
                    .attr('title', 'Cleanup in progress...');
                showDownloadStatus('Cleanup in progress...', 'info');
                // ... rest of your existing cleanup code ...
            });
        });

        // Update the existing updateProfileStatus function
        async function updateProfileStatus() {
            try {
                const response = await fetch('/profile-status');
                const data = await response.json();
                console.log('Profile status update received:', data);

                // Show all sections
                document.getElementById('profile-progress').style.display = 'block';
                document.getElementById('profile-status-messages').style.display = 'block';
                document.getElementById('profile-statistics').style.display = 'block';

                // Update progress bar
                const progress = data.total_artifacts ? 
                    Math.round((data.processed_artifacts / data.total_artifacts) * 100) : 0;
                document.getElementById('profile-progress-bar').style.width = `${progress}%`;
                document.getElementById('profile-progress-bar').textContent = `${progress}%`;

                // Update statistics if available
                if (data.statistics) {
                    document.getElementById('profile-artifacts-processed').textContent = data.statistics.artifacts_processed;
                    document.getElementById('profile-success-rate').textContent = `${data.statistics.success_rate}%`;
                    document.getElementById('profile-total-time').textContent = `${data.statistics.total_execution_time}s`;
                    document.getElementById('profile-avg-time').textContent = `${data.statistics.average_execution_time}s`;
                }

                // Update status messages
                const messagesContainer = document.getElementById('profile-messages-container');
                messagesContainer.innerHTML = data.messages.map(msg => `
                    <div class="status-message ${msg.type || 'info'}">
                        <span class="timestamp">[${msg.timestamp}]</span>
                        <span class="message-content">${msg.message}</span>
                        ${msg.elapsed ? `<span class="elapsed-time">${msg.elapsed}</span>` : ''}
                    </div>
                `).join('');

                // Auto-scroll to the bottom of the messages container
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Update download button state
                updateDownloadButton(data);

                // If processing is complete, show results
                if (data.completed && data.artifact_results && data.artifact_results.length > 0) {
                    document.getElementById('profile-results').style.display = 'block';
                    const result = data.artifact_results[0];
                    
                    // Update results content
                    document.getElementById('profile-results-content').innerHTML = `
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Test Run at ${result.timestamp}</h6>
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <h6>Successful Artifacts (${result.stats.successful.length})</h6>
                                        <div class="artifact-list">
                                            ${result.stats.successful.map(artifact => `
                                                <div class="artifact-item">
                                                    <div class="artifact-info">
                                                        <i class="fas fa-check-circle text-success"></i>
                                                        <span class="artifact-name">${artifact.name}</span>
                                                    </div>
                                                    <div class="artifact-meta">
                                                        <span class="execution-time">
                                                            <i class="fas fa-stopwatch"></i>
                                                            ${artifact.execution_time}s
                                                        </span>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Failed Artifacts (${result.stats.failed.length})</h6>
                                        <div class="artifact-list">
                                            ${result.stats.failed.map(artifact => `
                                                <div class="artifact-item">
                                                    <div class="artifact-info">
                                                        <i class="fas fa-times-circle text-danger"></i>
                                                        <span class="artifact-name">${artifact.name}</span>
                                                    </div>
                                                    <div class="artifact-meta">
                                                        <span class="execution-time">
                                                            <i class="fas fa-stopwatch"></i>
                                                            ${artifact.execution_time}s
                                                        </span>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    console.log('Processing completed, final button state update');
                    return false; // Stop polling
                }
                return true; // Continue polling
            } catch (error) {
                console.error('Error fetching profile status:', error);
                showDownloadStatus('Error checking profile status: ' + error, 'error');
                return true; // Continue polling despite error
            }
        }

        // Function to start profile status polling
        function startProfileStatusPolling() {
            const poll = async () => {
                if (await updateProfileStatus()) {
                    setTimeout(poll, 1000);
                }
            };
            poll();
        }

        function updateTestProfileStatus() {
            fetch('/test-profile-status')
                .then(response => response.json())
                .then(data => {
                    // Update progress
                    const progress = data.total_artifacts ? 
                        Math.round((data.processed / data.total_artifacts) * 100) : 0;
                    document.getElementById('test-profile-progress-bar').style.width = `${progress}%`;
                    document.getElementById('test-profile-progress-bar').textContent = `${progress}%`;

                    // Update status messages
                    const statusDiv = document.getElementById('test-profile-status');
                    statusDiv.innerHTML = data.messages.map(msg => `
                        <div class="status-message ${msg.type}">
                            <span class="timestamp">[${msg.timestamp}]</span>
                            <span class="message-content">${msg.message}</span>
                            <span class="elapsed-time">${msg.elapsed}</span>
                        </div>
                    `).join('');

                    // Continue polling if processing is not complete
                    if (data.processing) {
                        setTimeout(updateTestProfileStatus, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching test profile status:', error);
                });
        }

        // Add event listener for test profile tab
        document.getElementById('test-profile-tab-link').addEventListener('click', function() {
            updateTestProfileStatus();
        });
    </script>
</body>
</html> 